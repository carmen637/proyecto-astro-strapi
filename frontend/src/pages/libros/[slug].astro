---
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  try {
    const response = await fetch('http://18.201.196.247:1337/api/libros');
    const data = await response.json();
    return data.data.map(libro => ({
      params: { slug: libro.slug }
    }));
  } catch (error) {
    console.error('Error en getStaticPaths:', error);
    return [];
  }
}

const { slug } = Astro.params;

let libro = null;

try {
  const response = await fetch(`http://18.201.196.247:1337/api/libros?filters[slug][$eq]=${slug}&populate[0]=portada&populate[1]=tradicion_rel&populate[2]=seo`);
  const data = await response.json();
  libro = data.data?.[0];
} catch (error) {
  console.error('Error al cargar el libro:', error);
}

if (!libro) {
  return Astro.redirect('/libros');
}
---

<Layout title={libro.seo?.meta_title || `${libro.titulo} | Biblioteca Arcana`} description={libro.seo?.meta_description || libro.sinopsis}>
  <section class="min-h-screen bg-gradient-to-b from-[#0B0F2A] to-[#050814] py-24">
    <div class="max-w-5xl mx-auto px-6">

      <!-- Breadcrumb -->
      <nav class="text-sm text-gray-500 mb-12">
        <a href="/" class="hover:text-[#FACC15] transition">Inicio</a>
        <span class="mx-2">›</span>
        <a href="/libros" class="hover:text-[#FACC15] transition">Catálogo</a>
        <span class="mx-2">›</span>
        <span class="text-gray-300">{libro.titulo}</span>
      </nav>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-16 items-start">

        <!-- Imagen -->
        <div class="md:sticky md:top-24">
  {libro.portada?.url 
    ? <img 
        src={`http://18.201.196.247:1337${libro.portada.url}`} 
        alt={libro.titulo}
        class="w-full max-w-sm mx-auto md:max-w-full rounded-xl border border-white/10 shadow-2xl"
      />
    : <div class="w-full aspect-[3/4] bg-[#111827] rounded-xl border border-white/10 flex items-center justify-center text-6xl">✦</div>
  }
</div>

        <!-- Info -->
        <div class="text-white">
          {libro.tradicion_rel?.nombre && (
            <span class="text-[#FACC15] text-sm uppercase tracking-widest mb-4 block">
              {libro.tradicion_rel.nombre}
            </span>
          )}

          <h1 class="text-white mb-3">{libro.titulo}</h1>
          <p class="text-gray-400 text-lg mb-8">por <span class="text-gray-200">{libro.autor}</span></p>

          <!-- Valoración -->
          <div class="flex items-center gap-2 mb-8">
            <span class="text-[#FACC15] text-xl">{'★'.repeat(Math.round(libro.valoracion))}{'☆'.repeat(5 - Math.round(libro.valoracion))}</span>
            <span class="text-gray-400 text-sm">{libro.valoracion}/5</span>
          </div>

          <p class="text-gray-300 leading-relaxed mb-10">{libro.sinopsis}</p>

          <!-- Detalles -->
          <div class="grid grid-cols-2 gap-4 mb-10 text-sm">
            <div class="bg-[#111827] rounded-lg p-4 border border-white/10">
              <p class="text-gray-500 mb-1">Editorial</p>
              <p class="text-gray-200">{libro.editorial}</p>
            </div>
            <div class="bg-[#111827] rounded-lg p-4 border border-white/10">
              <p class="text-gray-500 mb-1">Páginas</p>
              <p class="text-gray-200">{libro.paginas}</p>
            </div>
            <div class="bg-[#111827] rounded-lg p-4 border border-white/10">
              <p class="text-gray-500 mb-1">Nivel</p>
              <p class="text-gray-200">{libro.nivel}</p>
            </div>
            <div class="bg-[#111827] rounded-lg p-4 border border-white/10">
              <p class="text-gray-500 mb-1">Idioma</p>
              <p class="text-gray-200">{libro.idioma}</p>
            </div>
          </div>

          <!-- Precio y CTA -->
<div class="mt-6">
  <span class="text-4xl font-bold text-[#FACC15]">{libro.precio}€</span>
  <div class="flex gap-4 mt-6">
    <button 
      onclick={`añadirAlCarrito('${libro.slug}', '${libro.titulo}', '${libro.autor}', '${libro.precio}', 'http://18.201.196.247:1337${libro.portada?.url || ''}')`}
      class="flex-1 border border-[#FACC15] text-[#FACC15] hover:bg-[#FACC15] hover:text-black px-6 py-3 rounded-lg transition font-semibold"
    >
      + Añadir al carrito
    </button>
  </div>
</div>
        </div>

      </div>
    </div>
  </section>
  <div id="toast" class="fixed bottom-6 right-6 bg-[#0B0F2A] border border-[#FACC15]/30 text-white px-6 py-4 rounded-xl shadow-2xl z-50 hidden transition-all duration-300">
  <p id="toast-mensaje" class="text-sm font-semibold"></p>
</div>
</Layout>
<script>
  function mostrarToast(mensaje) {
  const toast = document.getElementById('toast');
  const toastMensaje = document.getElementById('toast-mensaje');
  toastMensaje.textContent = mensaje;
  toast.classList.remove('hidden');
  setTimeout(() => toast.classList.add('hidden'), 3000);
}

window.añadirAlCarrito = (slug, titulo, autor, precio, portada, stock) => {
  const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
  const existe = carrito.find(l => l.slug === slug);
  if (existe) {
    mostrarToast('Este libro ya está en tu carrito');
    return;
  }
  carrito.push({ slug, titulo, autor, precio, portada, cantidad: 1, stock: parseInt(stock) });
  localStorage.setItem('carrito', JSON.stringify(carrito));
  window.dispatchEvent(new Event('carritoActualizado'));
  mostrarToast(`✦ "${titulo}" añadido al carrito`);
};
</script>